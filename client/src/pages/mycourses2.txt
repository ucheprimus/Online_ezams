// client/src/pages/MyCourses.jsx
import { useState, useEffect } from "react";
import { Link } from "react-router-dom";
import { useAuth } from "../context/AuthContext";
import {
  Container,
  Row,
  Col,
  Card,
  Button,
  Badge,
  Alert,
  Modal,
  Toast,
  ToastContainer,
  Pagination,
  Spinner,
  ProgressBar
} from "react-bootstrap";
import axios from "axios";
import "./MyCourses.css";

const MyCourses = () => {
  const { user, isInstructor } = useAuth();
  const [courses, setCourses] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [courseToDelete, setCourseToDelete] = useState(null);
  const [deleteLoading, setDeleteLoading] = useState(false);
  const [showShareToast, setShowShareToast] = useState(false);
  const [copiedCourseTitle, setCopiedCourseTitle] = useState("");
  
  // Pagination state
  const [pagination, setPagination] = useState({
    currentPage: 1,
    totalPages: 1,
    total: 0,
    limit: 6
  });

  // Default thumbnails for fallback
  const defaultThumbnails = {
    'web-dev': 'https://images.unsplash.com/photo-1555066931-4365d14bab8c?w=400&h=225&fit=crop',
    'data-science': 'https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=400&h=225&fit=crop',
    'mobile-dev': 'https://images.unsplash.com/photo-1512941937669-90a1b58e7e9c?w=400&h=225&fit=crop',
    'design': 'https://images.unsplash.com/photo-1561070791-2526d30994b5?w=400&h=225&fit=crop',
    'business': 'https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=400&h=225&fit=crop',
    'marketing': 'https://images.unsplash.com/photo-1432888622747-4eb9a8efeb07?w=400&h=225&fit=crop',
    'music': 'https://images.unsplash.com/photo-1470225620780-dba8ba36b745?w=400&h=225&fit=crop',
    'photography': 'https://images.unsplash.com/photo-1502920917128-1aa500764cbd?w=400&h=225&fit=crop',
    'default': 'https://images.unsplash.com/photo-1496171367470-9ed9a91ea931?w=400&h=225&fit=crop'
  };

  useEffect(() => {
    fetchMyCourses();
  }, [pagination.currentPage]);

const fetchMyCourses = async () => {
  try {
    setLoading(true);
    const token = localStorage.getItem("token");

    if (isInstructor) {
      // For instructors - get courses they created
      const response = await axios.get(
        `http://localhost:5000/api/courses/instructor/my-courses?page=${pagination.currentPage}&limit=${pagination.limit}`,
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );
      
      // Handle both response formats
      if (response.data.courses) {
        // Response has pagination structure
        setCourses(response.data.courses || []);
        setPagination({
          currentPage: response.data.currentPage || 1,
          totalPages: response.data.totalPages || 1,
          total: response.data.total || 0,
          limit: pagination.limit
        });
      } else {
        // Response is just an array of courses
        const allCourses = response.data;
        const startIndex = (pagination.currentPage - 1) * pagination.limit;
        const endIndex = startIndex + pagination.limit;
        const paginatedCourses = allCourses.slice(startIndex, endIndex);
        
        setCourses(paginatedCourses);
        setPagination(prev => ({
          ...prev,
          total: allCourses.length,
          totalPages: Math.ceil(allCourses.length / pagination.limit)
        }));
      }
    } else {
      // For students - get actual enrolled courses
      console.log("ðŸ” DEBUG: Fetching actual enrolled courses...");
      console.log("ðŸ‘¤ DEBUG: Current user ID:", user?.id);
      console.log("ðŸ‘¤ DEBUG: Current user object:", user);
      
      // Method 1: Try to get enrolled courses from all courses by filtering
      const allCoursesResponse = await axios.get(
        `http://localhost:5000/api/courses?page=1&limit=100`,
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );
      
      const allCourses = allCoursesResponse.data.courses || allCoursesResponse.data || [];
      console.log("ðŸ“š DEBUG: Total courses found:", allCourses.length);
      
      // Debug: Log all courses and their enrollment data
      console.log("ðŸ” DEBUG: Checking enrollment for each course:");
      allCourses.forEach((course, index) => {
        console.log(`ðŸ“– Course ${index + 1}: "${course.title}"`, {
          courseId: course._id,
          studentsEnrolled: course.studentsEnrolled,
          enrolledCount: course.studentsEnrolled?.length || 0,
          studentsEnrolledType: typeof course.studentsEnrolled?.[0]
        });
      });
      
      // Filter courses where the current user is enrolled
      const enrolledCourses = allCourses.filter(course => {
        if (!course.studentsEnrolled || course.studentsEnrolled.length === 0) {
          console.log(`âŒ No students enrolled in: "${course.title}"`);
          return false;
        }
        
        // Check if user is enrolled in this course
        const isEnrolled = course.studentsEnrolled.some(student => {
          // Handle both object and string formats
          let studentId;
          if (typeof student === 'object' && student !== null) {
            studentId = student._id || student.id;
          } else {
            studentId = student;
          }
          
          const isMatch = studentId === user?.id;
          
          if (isMatch) {
            console.log(`âœ… USER IS ENROLLED: "${course.title}"`);
            console.log(`   Student ID: ${studentId}, User ID: ${user?.id}`);
          }
          
          return isMatch;
        });
        
        if (!isEnrolled) {
          console.log(`âŒ User NOT enrolled in: "${course.title}"`);
          console.log(`   Available student IDs:`, course.studentsEnrolled.map(s => 
            typeof s === 'object' ? s._id || s.id : s
          ));
        }
        
        return isEnrolled;
      });

      console.log("ðŸŽ¯ DEBUG: Enrolled courses found:", enrolledCourses.length);
      console.log("ðŸ“‹ DEBUG: Enrolled courses list:", enrolledCourses.map(c => c.title));
      
      if (enrolledCourses.length === 0) {
        console.log("ðŸ¤” DEBUG: Why no enrolled courses? Possible issues:");
        console.log("   1. User hasn't enrolled in any courses");
        console.log("   2. Enrollment data not saved properly in backend");
        console.log("   3. User ID mismatch between frontend and backend");
        console.log("   4. Backend not returning studentsEnrolled data");
        console.log("   5. studentsEnrolled array is empty or null");
      }

      // Add progress data
      const coursesWithProgress = enrolledCourses.map(course => ({
        ...course,
        progress: calculateCourseProgress(user?.id, course)
      }));

      // Paginate the results
      const startIndex = (pagination.currentPage - 1) * pagination.limit;
      const endIndex = startIndex + pagination.limit;
      const paginatedCourses = coursesWithProgress.slice(startIndex, endIndex);
      
      setCourses(paginatedCourses);
      setPagination(prev => ({
        ...prev,
        total: enrolledCourses.length,
        totalPages: Math.ceil(enrolledCourses.length / pagination.limit)
      }));
    }
  } catch (err) {
    console.error("âŒ Fetch courses error:", err);
    
    if (isInstructor) {
      setError(err.response?.data?.message || "Failed to fetch your courses");
    } else {
      console.error("âŒ Student courses error details:", err.response?.data);
      setError("Failed to load your enrolled courses. Please try again.");
      setCourses([]);
    }
  } finally {
    setLoading(false);
  }
};

  // Helper function to calculate course progress (you need to implement this based on your data structure)
  const calculateCourseProgress = (userId, course) => {
    // This is a placeholder - implement based on your progress tracking system
    // For example, if you track completed lessons:
    // const completedLessons = user.completedLessons.filter(lesson => course.lectures.includes(lesson))
    // return (completedLessons.length / course.lectures.length) * 100;
    
    // For now, return a random progress or 0
    return Math.floor(Math.random() * 100); // Random progress for demo
  };

  const handlePageChange = (page) => {
    setPagination(prev => ({ ...prev, currentPage: page }));
  };

  const handlePublishToggle = async (courseId, currentStatus) => {
    try {
      const token = localStorage.getItem("token");
      await axios.put(
        `http://localhost:5000/api/courses/${courseId}`,
        { isPublished: !currentStatus },
        { headers: { Authorization: `Bearer ${token}` } }
      );

      // Update local state
      setCourses(
        courses.map((course) =>
          course._id === courseId
            ? { ...course, isPublished: !currentStatus }
            : course
        )
      );
    } catch (err) {
      setError(err.response?.data?.message || "Failed to update course");
    }
  };

  const handleDeleteClick = (course) => {
    setCourseToDelete(course);
    setShowDeleteModal(true);
  };

  const handleDeleteConfirm = async () => {
    if (!courseToDelete) return;

    setDeleteLoading(true);
    try {
      const token = localStorage.getItem("token");
      await axios.delete(
        `http://localhost:5000/api/courses/${courseToDelete._id}`,
        { headers: { Authorization: `Bearer ${token}` } }
      );

      setCourses(courses.filter((c) => c._id !== courseToDelete._id));
      setShowDeleteModal(false);
      setCourseToDelete(null);
      
      // Refresh the courses list
      fetchMyCourses();
    } catch (err) {
      setError(err.response?.data?.message || "Failed to delete course");
    } finally {
      setDeleteLoading(false);
    }
  };

  const handleShareCourse = async (course) => {
    try {
      const courseUrl = `${window.location.origin}/courses/${course._id}`;
      
      if (navigator.share) {
        await navigator.share({
          title: course.title,
          text: course.description,
          url: courseUrl,
        });
      } else {
        await navigator.clipboard.writeText(courseUrl);
        setCopiedCourseTitle(course.title);
        setShowShareToast(true);
      }
    } catch (err) {
      console.error('Error sharing course:', err);
      try {
        const courseUrl = `${window.location.origin}/courses/${course._id}`;
        await navigator.clipboard.writeText(courseUrl);
        setCopiedCourseTitle(course.title);
        setShowShareToast(true);
      } catch (clipboardErr) {
        setError('Failed to share course link');
      }
    }
  };

  const getCategoryDisplayName = (category) => {
    const categoryMap = {
      'web-dev': 'Web Development',
      'data-science': 'Data Science',
      'mobile-dev': 'Mobile Development',
      'design': 'Design',
      'business': 'Business',
      'marketing': 'Marketing',
      'music': 'Music',
      'photography': 'Photography'
    };
    return categoryMap[category] || category;
  };

  const renderPagination = () => {
    if (pagination.totalPages <= 1) return null;

    let items = [];
    for (let number = 1; number <= pagination.totalPages; number++) {
      items.push(
        <Pagination.Item
          key={number}
          active={number === pagination.currentPage}
          onClick={() => handlePageChange(number)}
        >
          {number}
        </Pagination.Item>
      );
    }

    return (
      <div className="pagination-container">
        <Pagination>
          <Pagination.Prev
            disabled={pagination.currentPage === 1}
            onClick={() => handlePageChange(pagination.currentPage - 1)}
          />
          {items}
          <Pagination.Next
            disabled={pagination.currentPage === pagination.totalPages}
            onClick={() => handlePageChange(pagination.currentPage + 1)}
          />
        </Pagination>
      </div>
    );
  };

  if (loading) {
    return (
      <Container fluid className="my-courses-container px-3 px-md-4 py-4">
        <div className="loading-spinner">
          <Spinner animation="border" variant="primary" />
          <p className="mt-3 text-muted">Loading your courses...</p>
        </div>
      </Container>
    );
  }

  return (
    <Container fluid className="my-courses-container px-3 px-md-4 py-4">
      {/* Header */}
      <Row className="mb-4">
        <Col md={8}>
          <h1 className="page-title">
            {isInstructor ? "My Courses" : "My Learning"}
          </h1>
          <p className="page-subtitle">
            {isInstructor
              ? "Manage and track your course content"
              : "Track your progress and continue learning"}
          </p>
        </Col>
        {isInstructor && (
          <Col md={4} className="text-md-end mt-3 mt-md-0">
            <Button
              as={Link}
              to="/dashboard/create-course"
              className="create-btn"
            >
              <i className="bi bi-plus-circle me-2"></i>
              Create New Course
            </Button>
          </Col>
        )}
        {!isInstructor && courses.length > 0 && (
          <Col md={4} className="text-md-end mt-3 mt-md-0">
            <Button
              as={Link}
              to="/dashboard/browse"
              variant="outline-primary"
            >
              <i className="bi bi-search me-2"></i>
              Browse More Courses
            </Button>
          </Col>
        )}
      </Row>

      {error && (
        <Alert variant="danger" dismissible onClose={() => setError("")} className="error-alert">
          <i className="bi bi-exclamation-triangle me-2"></i>
          {error}
        </Alert>
      )}

      {/* Remove the Demo Notice since we're showing real data now */}
      {!isInstructor && courses.length === 0 && (
        <Alert variant="info" className="mb-4">
          <i className="bi bi-info-circle me-2"></i>
          <strong>No enrolled courses yet.</strong> Browse courses and enroll to start learning!
        </Alert>
      )}

      {/* Courses List */}
      {courses.length === 0 ? (
        <Card className="empty-card border-0">
          <Card.Body className="text-center py-5">
            <div className="empty-icon mb-3">{isInstructor ? "ðŸ“š" : "ðŸŽ“"}</div>
            <h4 className="empty-title">
              {isInstructor ? "No courses created yet" : "No enrolled courses"}
            </h4>
            <p className="empty-description">
              {isInstructor
                ? "Start sharing your knowledge by creating your first course"
                : "Enroll in courses to start your learning journey and track your progress here"}
            </p>
            <Button
              as={Link}
              to={isInstructor ? "/dashboard/create-course" : "/dashboard/browse"}
              className="create-btn mt-3"
            >
              {isInstructor ? "Create Your First Course" : "Browse Courses"}
            </Button>
          </Card.Body>
        </Card>
      ) : (
        <>
          <Row>
            {courses.map((course) => (
              <Col key={course._id} lg={6} xl={4} className="mb-4">
                <Card className="course-card h-100 border-0">
                  <div className="course-thumbnail">
                    <img
                      src={
                        course.thumbnail && course.thumbnail.trim() !== '' 
                          ? course.thumbnail 
                          : (defaultThumbnails[course.category] || defaultThumbnails.default)
                      }
                      alt={course.title}
                      className={!course.thumbnail ? "fallback-image" : ""}
                      onError={(e) => {
                        e.target.onerror = null;
                        e.target.src = defaultThumbnails[course.category] || defaultThumbnails.default;
                        e.target.className = "fallback-image";
                      }}
                    />
                    {isInstructor && (
                      <div className="course-overlay">
                        <Badge
                          className={`status-badge ${course.isPublished ? 'published' : 'draft'}`}
                        >
                          {course.isPublished ? "Published" : "Draft"}
                        </Badge>
                      </div>
                    )}
                    {!isInstructor && (
                      <div className="progress-overlay">
                        <Badge className="progress-badge">
                          {course.progress || 0}% Complete
                        </Badge>
                      </div>
                    )}
                  </div>

                  <Card.Body className="p-4">
                    <div className="d-flex justify-content-between align-items-start mb-2">
                      <Badge bg="primary" className="category-badge">
                        {getCategoryDisplayName(course.category)}
                      </Badge>
                      <Badge bg="secondary" className="level-badge">
                        {course.level}
                      </Badge>
                    </div>

                    <h5 className="course-title">{course.title}</h5>
                    <p className="course-description">
                      {course.description.length > 100
                        ? course.description.substring(0, 100) + "..."
                        : course.description}
                    </p>

                    {/* Progress Bar for Students */}
                    {!isInstructor && (
                      <div className="progress-section mb-3">
                        <div className="d-flex justify-content-between align-items-center mb-1">
                          <small className="text-muted">Your Progress</small>
                          <small className="text-muted">{course.progress || 0}%</small>
                        </div>
                        <ProgressBar 
                          now={course.progress || 0} 
                          variant={(course.progress || 0) === 100 ? "success" : "primary"}
                          className="course-progress"
                        />
                      </div>
                    )}

                    <div className="course-stats mb-3">
                      {isInstructor ? (
                        // Instructor stats
                        <>
                          <div className="stat-item">
                            <i className="bi bi-people"></i>
                            <span>
                              {course.studentsEnrolled?.length || 0} students
                            </span>
                          </div>
                          <div className="stat-item">
                            <i className="bi bi-star-fill"></i>
                            <span>{course.averageRating || "0.0"}</span>
                          </div>
                          <div className="stat-item">
                            <i className="bi bi-currency-dollar"></i>
                            <span>
                              {course.price === 0 ? "Free" : `$${course.price}`}
                            </span>
                          </div>
                        </>
                      ) : (
                        // Student stats
                        <>
                          <div className="stat-item">
                            <i className="bi bi-clock"></i>
                            <span>{course.totalHours || '10'} hours</span>
                          </div>
                          <div className="stat-item">
                            <i className="bi bi-bar-chart"></i>
                            <span className="text-capitalize">{course.level}</span>
                          </div>
                          <div className="stat-item">
                            <i className="bi bi-person"></i>
                            <span>{course.instructor?.name || 'Instructor'}</span>
                          </div>
                        </>
                      )}
                    </div>

                    <div className={`course-actions ${isInstructor ? 'four-buttons' : 'three-buttons'}`}>
                      {isInstructor ? (
                        // Instructor actions
                        <>
                          <Button
                            variant={
                              course.isPublished
                                ? "outline-warning"
                                : "outline-success"
                            }
                            size="sm"
                            onClick={() =>
                              handlePublishToggle(course._id, course.isPublished)
                            }
                            className="action-btn"
                          >
                            <i
                              className={`bi bi-${
                                course.isPublished ? "eye-slash" : "eye"
                              } me-1`}
                            ></i>
                            <span>{course.isPublished ? "Unpublish" : "Publish"}</span>
                          </Button>

                          <Button
                            variant="outline-primary"
                            size="sm"
                            as={Link}
                            to={`/dashboard/edit-course/${course._id}`}
                            className="action-btn"
                          >
                            <i className="bi bi-pencil me-1"></i>
                            <span>Edit</span>
                          </Button>

                          <Button
                            variant="outline-info"
                            size="sm"
                            onClick={() => handleShareCourse(course)}
                            className="action-btn"
                            title="Share course"
                          >
                            <i className="bi bi-share me-1"></i>
                            <span>Share</span>
                          </Button>

                          <Button
                            variant="outline-danger"
                            size="sm"
                            onClick={() => handleDeleteClick(course)}
                            className="action-btn"
                          >
                            <i className="bi bi-trash me-1"></i>
                            <span>Delete</span>
                          </Button>
                        </>
                      ) : (
                        // Student actions
                        <>
                          <Button
                            variant="primary"
                            size="sm"
                            as={Link}
                            to={`/learn/${course._id}`}
                            className="action-btn continue-btn"
                          >
                            <i className="bi bi-play-circle me-1"></i>
                            <span>{(course.progress || 0) > 0 ? "Continue" : "Start Learning"}</span>
                          </Button>

                          <Button
                            variant="outline-secondary"
                            size="sm"
                            as={Link}
                            to={`/courses/${course._id}/progress`}
                            className="action-btn"
                          >
                            <i className="bi bi-graph-up me-1"></i>
                            <span>Details</span>
                          </Button>

                          <Button
                            variant="outline-info"
                            size="sm"
                            onClick={() => handleShareCourse(course)}
                            className="action-btn"
                            title="Share course"
                          >
                            <i className="bi bi-share me-1"></i>
                            <span>Share</span>
                          </Button>
                        </>
                      )}
                    </div>
                  </Card.Body>
                </Card>
              </Col>
            ))}
          </Row>
          
          {/* Pagination */}
          {renderPagination()}
        </>
      )}

      {/* Delete Confirmation Modal (Only for instructors) */}
      {isInstructor && (
        <Modal
          show={showDeleteModal}
          onHide={() => setShowDeleteModal(false)}
          centered
        >
          <Modal.Header closeButton>
            <Modal.Title>Delete Course</Modal.Title>
          </Modal.Header>
          <Modal.Body>
            <p>
              Are you sure you want to delete{" "}
              <strong>{courseToDelete?.title}</strong>?
            </p>
            <p className="text-danger mb-0">This action cannot be undone.</p>
          </Modal.Body>
          <Modal.Footer>
            <Button
              variant="secondary"
              onClick={() => setShowDeleteModal(false)}
            >
              Cancel
            </Button>
            <Button
              variant="danger"
              onClick={handleDeleteConfirm}
              disabled={deleteLoading}
              className={deleteLoading ? "loading" : ""}
            >
              {deleteLoading ? (
                <>
                  <span>Deleting...</span>
                </>
              ) : (
                "Delete Course"
              )}
            </Button>
          </Modal.Footer>
        </Modal>
      )}

      {/* Share Success Toast */}
      <ToastContainer position="top-end" className="p-3">
        <Toast 
          show={showShareToast} 
          onClose={() => setShowShareToast(false)}
          delay={3000}
          autohide
          className="toast-success"
        >
          <Toast.Header>
            <i className="bi bi-check-circle-fill text-success me-2"></i>
            <strong className="me-auto">Link Copied!</strong>
          </Toast.Header>
          <Toast.Body className="text-white">
            Course link for "{copiedCourseTitle}" copied to clipboard!
          </Toast.Body>
        </Toast>
      </ToastContainer>
    </Container>
  );
};

export default MyCourses;